name: CI Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  backend-tests:
    name: Backend Tests
    uses: ./.github/workflows/backend-tests.yml

  frontend-tests:
    name: Frontend Tests
    uses: ./.github/workflows/frontend-tests.yml

  code-quality:
    name: Code Quality Checks
    uses: ./.github/workflows/code-quality.yml

  security-scan:
    name: Security Scanning
    uses: ./.github/workflows/security-scan.yml
    if: github.event_name == 'push'

  all-checks-passed:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, code-quality]
    if: always()

    steps:
    - name: Check all jobs
      run: |
        if [[ "${{ needs.backend-tests.result }}" == "success" ]] && \
           [[ "${{ needs.frontend-tests.result }}" == "success" ]] && \
           [[ "${{ needs.code-quality.result }}" == "success" ]]; then
          echo "✅ All CI checks passed!"
          exit 0
        else
          echo "❌ Some CI checks failed"
          echo "Backend tests: ${{ needs.backend-tests.result }}"
          echo "Frontend tests: ${{ needs.frontend-tests.result }}"
          echo "Code quality: ${{ needs.code-quality.result }}"
          exit 1
        fi

    - name: Post status to PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '✅ All CI checks have passed! Ready for review.'
          })
